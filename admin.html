<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | TITAN Guild</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="titan logo png.png">
    <style>
        .admin-page { padding-top: 70px; min-height: 100vh; }

        /* Login Screen */
        .login-screen {
            min-height: calc(100vh - 70px);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 360px;
            text-align: center;
        }
        .login-box img { width: 80px; margin-bottom: 20px; }
        .login-box h2 { color: var(--horde-red-light); margin-bottom: 8px; font-size: 1.5rem; }
        .login-box p { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 24px; }
        .login-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            text-align: center;
            margin-bottom: 16px;
        }
        .login-input:focus { outline: none; border-color: var(--horde-red); }
        .login-btn {
            width: 100%;
            padding: 14px;
            background: var(--horde-red);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
        }
        .login-btn:hover { background: var(--horde-red-dark); }
        .login-error { color: #ef5350; font-size: 0.85rem; margin-top: 12px; display: none; }

        /* Admin Panel */
        .admin-panel { display: none; padding: 24px; }
        .admin-panel.active { display: block; }

        .admin-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .admin-tab {
            padding: 10px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
        }
        .admin-tab:hover { background: var(--bg-tertiary); }
        .admin-tab.active { background: var(--horde-red); border-color: var(--horde-red); color: white; }

        .admin-section { display: none; }
        .admin-section.active { display: block; }

        .admin-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .admin-card h3 {
            color: var(--horde-red-light);
            font-size: 1.1rem;
            margin-bottom: 16px;
        }

        /* Raid List */
        .raid-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .raid-item-info h4 { color: var(--text-primary); font-size: 1rem; }
        .raid-item-info p { color: var(--text-muted); font-size: 0.85rem; }
        .raid-item-actions { display: flex; gap: 8px; }
        .raid-item-actions button {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            border: none;
        }
        .btn-edit { background: #3b82f6; color: white; }
        .btn-edit:hover { background: #2563eb; }
        .btn-delete { background: #ef4444; color: white; }
        .btn-delete:hover { background: #dc2626; }
        .btn-parse { background: #22c55e; color: white; }
        .btn-parse:hover { background: #16a34a; }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-upcoming { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .status-completed { background: rgba(34, 197, 94, 0.2); color: #22c55e; }

        /* Form */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 8px; }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--horde-red); }
        .form-textarea { min-height: 120px; font-family: monospace; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        /* Composition Editor */
        .composition-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
        }
        .composition-tab {
            padding: 8px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
        }
        .composition-tab.active { background: var(--horde-red); border-color: var(--horde-red); color: white; }

        .composition-panel { display: none; }
        .composition-panel.active { display: block; }

        .player-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .player-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: var(--bg-primary);
            border-radius: 6px;
        }
        .player-item .class-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }
        .player-item .player-name { flex: 1; color: var(--text-primary); }
        .player-item .player-class { color: var(--text-muted); font-size: 0.85rem; }
        .player-item .remove-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
        }
        .player-item .remove-btn:hover { color: #ef4444; }

        /* Parse Results */
        .parse-results {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        .parse-results h4 { color: var(--text-primary); margin-bottom: 12px; }
        .parse-result-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
        }
        .parse-result-item:last-child { border-bottom: none; }
        .new-record { color: #22c55e; }

        .success-msg {
            padding: 16px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22c55e;
            border-radius: 8px;
            color: #22c55e;
            text-align: center;
            margin-top: 16px;
            display: none;
        }

        .error-msg {
            padding: 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 8px;
            color: #ef4444;
            text-align: center;
            margin-top: 16px;
            display: none;
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Filter buttons */
        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .filter-btn {
            padding: 6px 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
        }
        .filter-btn.active { background: var(--horde-red); border-color: var(--horde-red); color: white; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <nav class="nav" id="nav">
        <div class="nav-inner">
            <a href="/" class="nav-brand">
                <img src="titan logo png.png" alt="Titan Logo" class="nav-logo">
                <span class="nav-title">TITAN</span>
            </a>
            <ul class="nav-links">
                <li><a href="/" class="nav-link">Home</a></li>
                <li><a href="raids.html" class="nav-link">Raids</a></li>
                <li><a href="guild.html" class="nav-link">Guild</a></li>
                <li><a href="top-parsers.html" class="nav-link">Top Parsers</a></li>
                <li><a href="bis.html" class="nav-link">BiS List</a></li>
                <li><a href="guides.html" class="nav-link">Guides</a></li>
                <li><a href="join.html" class="nav-link">Join</a></li>
            </ul>
            <div class="nav-cta">
                <a href="join.html" class="btn btn-primary">Join Guild</a>
            </div>
            <button class="nav-toggle" id="navToggle"><span></span><span></span><span></span></button>
        </div>
    </nav>

    <div class="admin-page">
        <!-- Login Screen -->
        <div class="login-screen" id="loginScreen">
            <div class="login-box">
                <img src="titan logo png.png" alt="TITAN">
                <h2>Admin Panel</h2>
                <p>Enter password to continue</p>
                <input type="password" class="login-input" id="passwordInput" placeholder="Password" onkeypress="if(event.key==='Enter')login()">
                <button class="login-btn" onclick="login()">Login</button>
                <div class="login-error" id="loginError">Wrong password</div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div class="admin-panel container" id="adminPanel">
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="showTab('raids', this)">Raids</button>
                <button class="admin-tab" onclick="showTab('add-raid', this)">Add Raid</button>
                <button class="admin-tab" onclick="showTab('parse-logs', this)">Parse Logs</button>
                <button class="admin-tab" onclick="showTab('rankings', this)">Rankings</button>
                <button class="admin-tab" onclick="showTab('members', this)">Members</button>
                <button class="admin-tab" onclick="showTab('guides', this)">Guides/Addons</button>
            </div>

            <!-- Manage Raids Tab -->
            <div class="admin-section active" id="raids-tab">
                <div class="admin-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin-bottom: 0;">Raid List</h3>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="loadRaids()">Refresh</button>
                            <button class="btn btn-secondary" onclick="clearAllRaids()" style="background: #ef4444;">Clear All</button>
                        </div>
                    </div>

                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterRaids('all', this)">All</button>
                        <button class="filter-btn" onclick="filterRaids('upcoming', this)">Upcoming</button>
                        <button class="filter-btn" onclick="filterRaids('completed', this)">Completed</button>
                    </div>

                    <div id="raidsList">
                        <div class="empty-state">
                            <p>Loading raids...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Raid Tab -->
            <div class="admin-section" id="add-raid-tab">
                <div class="admin-card">
                    <h3>Add New Raid</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Raid Type</label>
                            <select class="form-select" id="newRaidType">
                                <option value="ICC 25 HC">ICC 25 HC (LoD)</option>
                                <option value="RS 25 HC">RS 25 HC</option>
                                <option value="ToGC 25">ToGC 25</option>
                                <option value="ICC 10 HC">ICC 10 HC</option>
                                <option value="RS 10 HC">RS 10 HC</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-input" id="newRaidDate">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Time (Server Time)</label>
                            <input type="time" class="form-input" id="newRaidTime" value="20:30">
                        </div>
                        <div class="form-group">
                            <label class="form-label">UwU Log URL (optional)</label>
                            <input type="url" class="form-input" id="newRaidLogUrl" placeholder="https://uwu-logs.xyz/reports/...">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes (optional)</label>
                        <input type="text" class="form-input" id="newRaidNotes" placeholder="e.g., LOD, BIS healers, etc.">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Paste Roster from Discord/Raid Helper (optional)</label>
                        <textarea class="form-textarea" id="newRaidRoster" placeholder="-Tanks-
:DK: Death Knight Tank - @PlayerName
:Protection: Prot Paladin - @PlayerName

-Meele Dps-
:Fury: Arms Warrior - @PlayerName
...

-Range Dps-
:Fire: Fire Mage - @PlayerName
...

-Healer-
:Restoration: Resto Druid - @PlayerName
..."></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="addRaid()">Add Raid</button>
                    <div class="success-msg" id="addRaidSuccess">Raid added successfully!</div>
                    <div class="error-msg" id="addRaidError"></div>
                </div>
            </div>

            <!-- Parse Logs Tab -->
            <div class="admin-section" id="parse-logs-tab">
                <div class="admin-card">
                    <h3>Parse UwU Log</h3>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px;">
                        Enter a UwU-logs.xyz URL to parse composition and DPS data. The system will update
                        top parser rankings if new records are found.
                    </p>

                    <div class="form-group">
                        <label class="form-label">UwU-logs.xyz Link</label>
                        <div style="display: flex; gap: 12px;">
                            <input type="url" class="form-input" id="parseLogUrl" placeholder="https://uwu-logs.xyz/reports/26-01-25--20-30--Waawaa--Icecrown/">
                            <button class="btn btn-primary" id="parseLogBtn" onclick="parseLog()">Parse Log</button>
                        </div>
                    </div>

                    <div id="parseResults" style="display: none;">
                        <div class="parse-results">
                            <h4>Parse Results</h4>
                            <div id="parseResultsContent"></div>
                        </div>
                    </div>

                    <div class="success-msg" id="parseSuccess"></div>
                    <div class="error-msg" id="parseError"></div>

                    <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border-subtle);">
                        <h4 style="color: var(--text-secondary); margin-bottom: 16px;">Manual Composition Entry</h4>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 16px;">
                            If automatic parsing fails, paste the raid composition from Discord here.
                        </p>

                        <div class="form-group">
                            <label class="form-label">Select Raid to Update</label>
                            <select class="form-select" id="manualRaidSelect">
                                <option value="">-- Select a raid --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Paste Composition</label>
                            <textarea class="form-textarea" id="manualComposition" placeholder="-Tanks-
:DK: Blood DK - @PlayerName
..."></textarea>
                        </div>

                        <button class="btn btn-secondary" onclick="saveManualComposition()">Save Composition</button>
                    </div>
                </div>
            </div>

            <!-- Rankings Tab -->
            <div class="admin-section" id="rankings-tab">
                <div class="admin-card">
                    <h3>Top Parsers Status</h3>

                    <div id="rankingsStatus" style="margin-bottom: 24px;">
                        <p style="color: var(--text-muted);">Loading...</p>
                    </div>

                    <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                        <button class="btn btn-secondary" onclick="loadRankingsStatus()">Refresh Status</button>
                        <button class="btn btn-secondary" onclick="exportRankings()">Export Data</button>
                    </div>

                    <div style="padding-top: 24px; border-top: 1px solid var(--border-subtle);">
                        <h4 style="color: var(--text-secondary); margin-bottom: 16px;">Import Rankings Data</h4>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 16px;">
                            Import rankings data from a JSON file.
                        </p>
                        <div class="form-group">
                            <textarea class="form-textarea" id="importRankingsData" placeholder='Paste JSON data here...'></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="importRankings()">Import Data</button>
                        <div class="success-msg" id="importSuccess">Data imported successfully!</div>
                        <div class="error-msg" id="importError"></div>
                    </div>
                </div>
            </div>

            <!-- Members Tab -->
            <div class="admin-section" id="members-tab">
                <div class="admin-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin-bottom: 0;">Guild Members</h3>
                        <button class="btn btn-primary" onclick="loadMembers()">Refresh</button>
                    </div>

                    <div id="membersStats" style="margin-bottom: 20px;">
                        <p style="color: var(--text-muted);">Loading stats...</p>
                    </div>

                    <div style="padding: 20px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: var(--text-secondary); margin-bottom: 16px;">Add New Member</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Character Name</label>
                                <input type="text" class="form-input" id="newMemberName" placeholder="e.g., Waawaa">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Class</label>
                                <select class="form-select" id="newMemberClass">
                                    <option value="Death Knight">Death Knight</option>
                                    <option value="Druid">Druid</option>
                                    <option value="Hunter">Hunter</option>
                                    <option value="Mage">Mage</option>
                                    <option value="Paladin">Paladin</option>
                                    <option value="Priest">Priest</option>
                                    <option value="Rogue">Rogue</option>
                                    <option value="Shaman">Shaman</option>
                                    <option value="Warlock">Warlock</option>
                                    <option value="Warrior">Warrior</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Rank</label>
                                <select class="form-select" id="newMemberRank">
                                    <option value="0">Guild Master</option>
                                    <option value="1">Officer</option>
                                    <option value="2">Veteran</option>
                                    <option value="3">Raider</option>
                                    <option value="4" selected>Member</option>
                                    <option value="5">Initiate</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Spec (optional)</label>
                                <input type="text" class="form-input" id="newMemberSpec" placeholder="e.g., Holy, Arms, Frost">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="addMember()">Add Member</button>
                        <div class="success-msg" id="addMemberSuccess">Member added!</div>
                        <div class="error-msg" id="addMemberError"></div>
                    </div>

                    <div id="membersList">
                        <div class="empty-state"><p>Loading members...</p></div>
                    </div>
                </div>
            </div>

            <!-- Guides/Addons Tab -->
            <div class="admin-section" id="guides-tab">
                <div class="admin-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="margin-bottom: 0;">Manage Addons & WeakAuras</h3>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="loadGuides()">Refresh</button>
                            <button class="btn btn-secondary" onclick="seedGuides()" style="background: #8b5cf6;">Sync Default Data</button>
                        </div>
                    </div>

                    <div class="filter-buttons" style="margin-bottom: 20px;">
                        <button class="filter-btn active" onclick="switchGuideType('addons', this)">Addons</button>
                        <button class="filter-btn" onclick="switchGuideType('weakauras', this)">WeakAuras</button>
                    </div>

                    <div style="padding: 20px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: var(--text-secondary); margin-bottom: 16px;">Add New <span id="guideTypeLabel">Addon</span></h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-input" id="newGuideName" placeholder="e.g., Fury Warrior, DBM-Warmane">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="newGuideCategory">
                                    <!-- Options set dynamically based on type -->
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-input" id="newGuideDesc" placeholder="Brief description...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">URL (Wago.io link or GitHub)</label>
                            <input type="url" class="form-input" id="newGuideUrl" placeholder="https://wago.io/... or https://github.com/...">
                        </div>
                        <div class="form-group" id="importStringGroup">
                            <label class="form-label">WeakAura Import String (paste the long string here)</label>
                            <textarea class="form-textarea" id="newGuideContent" placeholder="!WA:2!... (paste the full WeakAura import string)" style="min-height: 100px; font-family: monospace; font-size: 0.8rem;"></textarea>
                            <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 4px;">If provided, users can copy directly from the website without visiting Wago</p>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Priority (higher = shown first, e.g., 100 for important)</label>
                            <input type="number" class="form-input" id="newGuidePriority" value="50" min="0" max="100">
                        </div>
                        <button class="btn btn-primary" onclick="addGuide()">Add <span id="addGuideTypeLabel">Addon</span></button>
                        <div class="success-msg" id="addGuideSuccess">Added successfully!</div>
                        <div class="error-msg" id="addGuideError"></div>
                    </div>

                    <div id="guidesList">
                        <div class="empty-state"><p>Loading...</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Raid Modal -->
    <div id="editRaidModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: var(--bg-card); border-radius: 16px; padding: 32px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 style="color: var(--horde-red-light);">Edit Raid</h3>
                <button onclick="closeEditModal()" style="background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>

            <input type="hidden" id="editRaidId">

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Raid Type</label>
                    <select class="form-select" id="editRaidType">
                        <option value="ICC 25 HC">ICC 25 HC (LoD)</option>
                        <option value="RS 25 HC">RS 25 HC</option>
                        <option value="ToGC 25">ToGC 25</option>
                        <option value="ICC 10 HC">ICC 10 HC</option>
                        <option value="RS 10 HC">RS 10 HC</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="editRaidDate">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">UwU Log URL</label>
                <input type="url" class="form-input" id="editRaidLogUrl" placeholder="https://uwu-logs.xyz/reports/...">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="editRaidStatus">
                        <option value="upcoming">Upcoming</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Logger</label>
                    <input type="text" class="form-input" id="editRaidLogger" placeholder="Who logged the raid">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Notes</label>
                <input type="text" class="form-input" id="editRaidNotes">
            </div>

            <div class="form-group">
                <label class="form-label">Composition (from Discord)</label>
                <textarea class="form-textarea" id="editRaidComposition"></textarea>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button class="btn btn-primary" onclick="saveRaidEdit()">Save Changes</button>
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-promo" style="text-align: center; padding: 16px 0; margin-bottom: 16px; border-bottom: 1px solid var(--border-subtle);">
                <p style="color: var(--text-muted); font-size: 0.9rem;">Want your own website, iOS/Android app, or custom addon built? <a href="https://discord.com/users/abdellatiff" target="_blank" style="color: var(--horde-red-light);">Message me on Discord</a></p>
            </div>
            <div class="footer-bottom" style="border-top: none; padding-top: 0;">
                <p>&copy; 2026 T I T A N Guild. Warmane Icecrown.</p>
            </div>
        </div>
    </footer>

    <script>
        // Admin password - verified server-side
        const ADMIN_PASSWORD = 'titan2026';
        let allRaids = [];

        function login() {
            const pwd = document.getElementById('passwordInput').value;
            if (pwd === ADMIN_PASSWORD) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').classList.add('active');
                localStorage.setItem('titanAdmin', 'true');
                loadRaids();
                loadRankingsStatus();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        // Check if already logged in
        if (localStorage.getItem('titanAdmin') === 'true') {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminPanel').classList.add('active');
            loadRaids();
            loadRankingsStatus();
        }

        function showTab(tabId, clickedElement) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));

            // Find the tab button to highlight
            const tabButton = clickedElement || document.querySelector(`.admin-tab[onclick*="'${tabId}'"]`);
            if (tabButton) tabButton.classList.add('active');

            document.getElementById(tabId + '-tab').classList.add('active');

            // Load data for the selected tab
            if (tabId === 'members') loadMembers();
            if (tabId === 'guides') loadGuides();
            if (tabId === 'raids') loadRaids();
            if (tabId === 'rankings') loadRankingsStatus();
        }

        // ==================== RAIDS MANAGEMENT ====================

        let raidSearchTerm = '';
        let currentRaidFilter = 'all';

        async function resetRaids() {
            if (!confirm('This will clear all raids and sync with the 4 raids shown on the public Raids page. Continue?')) {
                return;
            }

            try {
                const response = await fetch('/api/clear-raids', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': ADMIN_PASSWORD
                    },
                    body: JSON.stringify({ action: 'clear-and-seed' })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Raids synced successfully! Now showing ' + result.raids + ' raids.');
                    loadRaids();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function clearAllRaids() {
            if (!confirm('This will DELETE ALL raids. Are you sure?')) {
                return;
            }

            try {
                const response = await fetch('/api/clear-raids', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': ADMIN_PASSWORD
                    },
                    body: JSON.stringify({ action: 'clear' })
                });

                const result = await response.json();
                if (result.success) {
                    alert('All raids cleared.');
                    loadRaids();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function loadRaids() {
            const container = document.getElementById('raidsList');
            container.innerHTML = '<div class="empty-state"><span class="loading"></span> Loading...</div>';

            try {
                const response = await fetch('/api/raids');
                const data = await response.json();
                allRaids = data.raids || [];

                displayRaids(allRaids);
                populateRaidSelect();
            } catch (error) {
                container.innerHTML = `<div class="empty-state"><p style="color: #ef4444;">Error loading raids: ${error.message}</p></div>`;
            }
        }

        function displayRaids(raids) {
            const container = document.getElementById('raidsList');

            // Apply search filter
            let filtered = raids;
            if (raidSearchTerm) {
                const term = raidSearchTerm.toLowerCase();
                filtered = raids.filter(r =>
                    (r.raidName || '').toLowerCase().includes(term) ||
                    (r.logger || r.postedBy || '').toLowerCase().includes(term) ||
                    (r.date || '').toLowerCase().includes(term) ||
                    (r.notes || '').toLowerCase().includes(term)
                );
            }

            // Apply status filter
            if (currentRaidFilter !== 'all') {
                filtered = filtered.filter(r => (r.status || 'completed') === currentRaidFilter);
            }

            let html = `
                <div style="margin-bottom: 16px;">
                    <input type="text" class="form-input" placeholder="Search raids (name, logger, date, notes)..."
                           value="${raidSearchTerm}"
                           oninput="raidSearchTerm = this.value; displayRaids(allRaids)">
                </div>
                <p style="color: var(--text-muted); margin-bottom: 12px;">Showing ${filtered.length} of ${raids.length} raids</p>
            `;

            if (filtered.length === 0) {
                html += '<div class="empty-state"><p>No raids found matching your criteria.</p></div>';
                container.innerHTML = html;
                return;
            }

            html += filtered.map((raid, idx) => {
                // Find actual index in allRaids for edit/delete
                const actualIndex = allRaids.findIndex(r => r.id === raid.id);
                const status = raid.status || 'completed';
                const raidName = raid.raidName || 'Unknown Raid';
                const dateStr = formatDate(raid.date);
                const logger = raid.logger || raid.postedBy || '';
                const loggerInfo = logger ? ` | Logger: ${logger}` : '';
                const notes = raid.notes ? ` | ${raid.notes.substring(0, 40)}${raid.notes.length > 40 ? '...' : ''}` : '';

                return `
                <div class="raid-item" data-status="${status}">
                    <div class="raid-item-info">
                        <h4>${raidName} - ${dateStr}</h4>
                        <p>
                            <span class="status-badge status-${status}">${status}</span>
                            ${loggerInfo}${notes}
                        </p>
                    </div>
                    <div class="raid-item-actions">
                        ${raid.uwuLogUrl ? `<a href="${raid.uwuLogUrl}" target="_blank" class="btn-parse" style="text-decoration: none;">View</a>` : ''}
                        ${raid.uwuLogUrl ? `<button class="btn-parse" onclick="parseRaidByIndex(${actualIndex})" style="background: #8b5cf6;">Parse</button>` : ''}
                        <button class="btn-edit" onclick="editRaidByIndex(${actualIndex})">Edit</button>
                        <button class="btn-delete" onclick="deleteRaidByIndex(${actualIndex})">Delete</button>
                    </div>
                </div>`;
            }).join('');

            container.innerHTML = html;
        }

        // Use index-based functions to avoid escaping issues
        function editRaidByIndex(index) {
            const raid = allRaids[index];
            if (raid) editRaid(raid.id);
        }

        function deleteRaidByIndex(index) {
            const raid = allRaids[index];
            if (raid) deleteRaid(raid.id);
        }

        function parseRaidByIndex(index) {
            const raid = allRaids[index];
            if (raid && raid.uwuLogUrl) {
                document.getElementById('parseLogUrl').value = raid.uwuLogUrl;
                showTab('parse-logs');
                parseLog();
            }
        }

        function filterRaids(status, btn) {
            document.querySelectorAll('#raids-tab .filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentRaidFilter = status;
            displayRaids(allRaids);
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'No date';
            try {
                // Handle various date formats
                let date = new Date(dateStr);

                // If invalid, try parsing common formats
                if (isNaN(date.getTime())) {
                    // Try DD-MM-YY or DD-MM-YYYY format
                    const parts = dateStr.split(/[-\/]/);
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1;
                        let year = parseInt(parts[2]);
                        if (year < 100) year += 2000;
                        date = new Date(year, month, day);
                    }
                }

                if (isNaN(date.getTime())) return dateStr; // Return original if still invalid

                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } catch (e) {
                return dateStr;
            }
        }

        async function addRaid() {
            const date = document.getElementById('newRaidDate').value;
            const raidName = document.getElementById('newRaidType').value;
            const time = document.getElementById('newRaidTime').value;
            const logUrl = document.getElementById('newRaidLogUrl').value;
            const notes = document.getElementById('newRaidNotes').value;
            const roster = document.getElementById('newRaidRoster').value;

            if (!date) {
                showError('addRaidError', 'Please select a date');
                return;
            }

            try {
                const response = await fetch('/api/raids', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': ADMIN_PASSWORD
                    },
                    body: JSON.stringify({
                        date: date,
                        raidName: raidName,
                        uwuLogUrl: logUrl,
                        notes: notes + (time ? ` | ${time} ST` : ''),
                        compositionText: roster
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showSuccess('addRaidSuccess', 'Raid added successfully!');
                    document.getElementById('newRaidDate').value = '';
                    document.getElementById('newRaidLogUrl').value = '';
                    document.getElementById('newRaidNotes').value = '';
                    document.getElementById('newRaidRoster').value = '';
                    loadRaids();
                } else {
                    showError('addRaidError', result.error);
                }
            } catch (error) {
                showError('addRaidError', error.message);
            }
        }

        function editRaid(raidId) {
            const raid = allRaids.find(r => r.id === raidId);
            if (!raid) return;

            document.getElementById('editRaidId').value = raid.id;
            document.getElementById('editRaidType').value = raid.raidName || 'ICC 25 HC';
            document.getElementById('editRaidDate').value = raid.date || '';
            document.getElementById('editRaidLogUrl').value = raid.uwuLogUrl || '';
            document.getElementById('editRaidNotes').value = raid.notes || '';
            document.getElementById('editRaidComposition').value = raid.compositionText || '';
            document.getElementById('editRaidStatus').value = raid.status || 'completed';
            document.getElementById('editRaidLogger').value = raid.logger || raid.postedBy || '';

            document.getElementById('editRaidModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editRaidModal').style.display = 'none';
        }

        async function saveRaidEdit() {
            const id = document.getElementById('editRaidId').value;

            try {
                const response = await fetch('/api/raids', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': ADMIN_PASSWORD
                    },
                    body: JSON.stringify({
                        id: id,
                        raidName: document.getElementById('editRaidType').value,
                        date: document.getElementById('editRaidDate').value,
                        uwuLogUrl: document.getElementById('editRaidLogUrl').value,
                        notes: document.getElementById('editRaidNotes').value,
                        compositionText: document.getElementById('editRaidComposition').value,
                        status: document.getElementById('editRaidStatus').value,
                        logger: document.getElementById('editRaidLogger').value
                    })
                });

                const result = await response.json();
                if (result.success) {
                    closeEditModal();
                    loadRaids();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteRaid(raidId) {
            if (!confirm('Are you sure you want to delete this raid?')) return;

            try {
                const response = await fetch(`/api/raids?id=${raidId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-Admin-Password': ADMIN_PASSWORD
                    }
                });

                const result = await response.json();
                if (result.success) {
                    loadRaids();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ==================== LOG PARSING ====================

        async function parseLog() {
            const logUrl = document.getElementById('parseLogUrl').value.trim();
            if (!logUrl || !logUrl.includes('uwu-logs.xyz')) {
                showError('parseError', 'Please enter a valid UwU-logs.xyz link');
                return;
            }

            const btn = document.getElementById('parseLogBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Parsing...';

            document.getElementById('parseResults').style.display = 'none';
            document.getElementById('parseSuccess').style.display = 'none';
            document.getElementById('parseError').style.display = 'none';

            try {
                const response = await fetch('/api/parse-uwu', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': ADMIN_PASSWORD
                    },
                    body: JSON.stringify({ logUrl: logUrl })
                });

                const result = await response.json();

                if (result.success) {
                    displayParseResults(result);
                    showSuccess('parseSuccess', `Log parsed! ${result.updates?.length || 0} new records found.`);
                    loadRankingsStatus();
                } else if (result.fallback) {
                    showError('parseError', 'Could not automatically parse log. Please use manual composition entry below.');
                } else {
                    showError('parseError', result.error || 'Failed to parse log');
                }
            } catch (error) {
                showError('parseError', error.message);
            }

            btn.disabled = false;
            btn.textContent = 'Parse Log';
        }


        function displayParseResults(result) {
            const container = document.getElementById('parseResultsContent');
            let html = '';

            html += `<p><strong>Log ID:</strong> ${result.logId}</p>`;
            html += `<p><strong>Parse Method:</strong> ${result.parseMethod}</p>`;

            if (result.raidInfo) {
                html += `<p><strong>Date:</strong> ${result.raidInfo.date}</p>`;
                html += `<p><strong>Raid:</strong> ${result.raidInfo.raid}</p>`;
                html += `<p><strong>Boss Kills:</strong> ${result.raidInfo.bossKills}</p>`;
            }

            if (result.updates && result.updates.length > 0) {
                html += '<h5 style="margin-top: 16px; color: var(--text-primary);">New Records:</h5>';
                result.updates.slice(0, 10).forEach(u => {
                    const value = u.type === 'dps' ? u.new.dps : u.new.hps;
                    html += `<div class="parse-result-item">
                        <span>${u.boss}</span>
                        <span class="new-record">${u.new.player} (${u.new.class}) - ${value.toLocaleString()} ${u.type.toUpperCase()}</span>
                    </div>`;
                });
                if (result.updates.length > 10) {
                    html += `<p style="color: var(--text-muted); margin-top: 8px;">...and ${result.updates.length - 10} more</p>`;
                }
            }

            if (result.composition) {
                const comp = result.composition;
                const total = (comp.tanks?.length || 0) + (comp.melee?.length || 0) +
                              (comp.ranged?.length || 0) + (comp.healers?.length || 0);
                if (total > 0) {
                    html += `<h5 style="margin-top: 16px; color: var(--text-primary);">Composition (${total} players):</h5>`;
                    html += `<p>Tanks: ${comp.tanks?.length || 0} | Melee: ${comp.melee?.length || 0} | Ranged: ${comp.ranged?.length || 0} | Healers: ${comp.healers?.length || 0}</p>`;
                }
            }

            container.innerHTML = html;
            document.getElementById('parseResults').style.display = 'block';
        }

        function populateRaidSelect() {
            const select = document.getElementById('manualRaidSelect');
            select.innerHTML = '<option value="">-- Select a raid --</option>';
            allRaids.forEach(raid => {
                select.innerHTML += `<option value="${raid.id}">${raid.raidName} - ${formatDate(raid.date)}</option>`;
            });
        }

        async function saveManualComposition() {
            const raidId = document.getElementById('manualRaidSelect').value;
            const composition = document.getElementById('manualComposition').value.trim();

            if (!raidId) {
                alert('Please select a raid');
                return;
            }
            if (!composition) {
                alert('Please enter composition data');
                return;
            }

            try {
                const response = await fetch('/api/parse-uwu', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': ADMIN_PASSWORD
                    },
                    body: JSON.stringify({
                        raidId: raidId,
                        manualComposition: composition
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(`Composition saved! ${result.playerCount} players parsed.`);
                    document.getElementById('manualComposition').value = '';
                    loadRaids();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ==================== RANKINGS ====================

        async function loadRankingsStatus() {
            const container = document.getElementById('rankingsStatus');

            try {
                const response = await fetch('/api/top-parsers');
                const data = await response.json();

                const dpsCount = Object.keys(data.dps || {}).length;
                const hpsCount = Object.keys(data.hps || {}).length;

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                            <p style="color: var(--text-muted); font-size: 0.85rem;">Total Logs</p>
                            <p style="color: var(--text-primary); font-size: 1.5rem; font-weight: 600;">${data.totalLogs || 0}</p>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                            <p style="color: var(--text-muted); font-size: 0.85rem;">DPS Bosses</p>
                            <p style="color: var(--text-primary); font-size: 1.5rem; font-weight: 600;">${dpsCount}</p>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                            <p style="color: var(--text-muted); font-size: 0.85rem;">HPS Bosses</p>
                            <p style="color: var(--text-primary); font-size: 1.5rem; font-weight: 600;">${hpsCount}</p>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                            <p style="color: var(--text-muted); font-size: 0.85rem;">Last Updated</p>
                            <p style="color: var(--text-primary); font-size: 0.9rem;">${data.generated ? new Date(data.generated).toLocaleDateString() : 'N/A'}</p>
                        </div>
                    </div>
                    <p style="margin-top: 16px; color: var(--text-muted); font-size: 0.85rem;">
                        Date range: ${data.dateRange?.from || 'N/A'} to ${data.dateRange?.to || 'N/A'}
                    </p>
                `;
            } catch (error) {
                container.innerHTML = `<p style="color: #ef4444;">Error loading status: ${error.message}</p>`;
            }
        }

        async function exportRankings() {
            try {
                const response = await fetch('/api/top-parsers');
                const data = await response.json();

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `titan-rankings-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error exporting: ' + error.message);
            }
        }

        async function importRankings() {
            const dataStr = document.getElementById('importRankingsData').value.trim();
            if (!dataStr) {
                showError('importError', 'Please paste JSON data');
                return;
            }

            try {
                const data = JSON.parse(dataStr);

                const response = await fetch('/api/top-parsers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': ADMIN_PASSWORD
                    },
                    body: JSON.stringify({
                        action: 'import',
                        data: data
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showSuccess('importSuccess', 'Data imported successfully!');
                    document.getElementById('importRankingsData').value = '';
                    loadRankingsStatus();
                } else {
                    showError('importError', result.error);
                }
            } catch (error) {
                showError('importError', 'Invalid JSON: ' + error.message);
            }
        }

        // ==================== MEMBERS MANAGEMENT ====================

        let allMembers = [];

        async function loadMembers() {
            const container = document.getElementById('membersList');
            container.innerHTML = '<div class="empty-state"><span class="loading"></span> Loading...</div>';

            try {
                const response = await fetch('/api/members');
                const data = await response.json();
                allMembers = data.members || [];

                // Update stats
                document.getElementById('membersStats').innerHTML = `
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <span style="color: var(--text-primary);">Total: <strong>${data.totalMembers || 0}</strong></span>
                        ${Object.entries(data.byClass || {}).map(([cls, count]) =>
                            `<span style="color: var(--text-muted);">${cls}: ${count}</span>`
                        ).join('')}
                    </div>
                `;

                displayMembers(allMembers);
            } catch (error) {
                container.innerHTML = `<div class="empty-state"><p style="color: #ef4444;">Error: ${error.message}</p></div>`;
            }
        }

        let membersDisplayCount = 50;
        let memberSearchTerm = '';

        function displayMembers(members) {
            const container = document.getElementById('membersList');

            if (members.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No members found. Add your first member!</p></div>';
                return;
            }

            // Filter by search
            let filtered = members;
            if (memberSearchTerm) {
                filtered = members.filter(m =>
                    m.name.toLowerCase().includes(memberSearchTerm.toLowerCase()) ||
                    m.class.toLowerCase().includes(memberSearchTerm.toLowerCase())
                );
            }

            const rankNames = { 0: 'GM', 1: 'Officer', 2: 'Veteran', 3: 'Raider', 4: 'Member', 5: 'Initiate' };
            const toShow = filtered.slice(0, membersDisplayCount);

            let html = `
                <div style="margin-bottom: 16px;">
                    <input type="text" class="form-input" placeholder="Search members..."
                           value="${memberSearchTerm}"
                           oninput="memberSearchTerm = this.value; membersDisplayCount = 50; displayMembers(allMembers)">
                </div>
                <p style="color: var(--text-muted); margin-bottom: 12px;">Showing ${toShow.length} of ${filtered.length} members</p>
            `;

            html += toShow.map(member => `
                <div class="raid-item">
                    <div class="raid-item-info">
                        <h4>${member.name}</h4>
                        <p>${member.class} ${member.spec ? `(${member.spec})` : ''} | ${rankNames[member.rank] || 'Member'}</p>
                    </div>
                    <div class="raid-item-actions">
                        <button class="btn-edit" onclick="editMember('${member.id}')">Edit</button>
                        <button class="btn-delete" onclick="deleteMember('${member.id}')">Remove</button>
                    </div>
                </div>
            `).join('');

            if (toShow.length < filtered.length) {
                html += `<button class="btn btn-secondary" style="width: 100%; margin-top: 12px;"
                                 onclick="membersDisplayCount += 50; displayMembers(allMembers)">
                            Load More (${filtered.length - toShow.length} remaining)
                         </button>`;
            }

            container.innerHTML = html;
        }

        async function addMember() {
            const name = document.getElementById('newMemberName').value.trim();
            const playerClass = document.getElementById('newMemberClass').value;
            const rank = parseInt(document.getElementById('newMemberRank').value);
            const spec = document.getElementById('newMemberSpec').value.trim();

            if (!name) {
                showError('addMemberError', 'Please enter a character name');
                return;
            }

            try {
                const response = await fetch('/api/members', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': ADMIN_PASSWORD
                    },
                    body: JSON.stringify({
                        name,
                        class: playerClass,
                        rank,
                        spec
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showSuccess('addMemberSuccess', 'Member added!');
                    document.getElementById('newMemberName').value = '';
                    document.getElementById('newMemberSpec').value = '';
                    loadMembers();
                } else {
                    showError('addMemberError', result.error);
                }
            } catch (error) {
                showError('addMemberError', error.message);
            }
        }

        function editMember(memberId) {
            const member = allMembers.find(m => m.id === memberId);
            if (!member) return;

            const newName = prompt('Character Name:', member.name);
            if (newName === null) return;

            const newSpec = prompt('Spec:', member.spec || '');
            if (newSpec === null) return;

            updateMember(memberId, { name: newName, spec: newSpec });
        }

        async function updateMember(memberId, updates) {
            try {
                const response = await fetch('/api/members', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': ADMIN_PASSWORD
                    },
                    body: JSON.stringify({ id: memberId, ...updates })
                });

                const result = await response.json();
                if (result.success) {
                    loadMembers();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteMember(memberId) {
            if (!confirm('Remove this member?')) return;

            try {
                const response = await fetch(`/api/members?id=${memberId}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Password': ADMIN_PASSWORD }
                });

                const result = await response.json();
                if (result.success) {
                    loadMembers();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ==================== GUIDES/ADDONS MANAGEMENT ====================

        let currentGuideType = 'addons';
        let allGuides = [];

        const addonCategories = ['Required', 'Recommended', 'Collection', 'Utility'];
        const waCategories = ['DPS', 'Healer', 'Tank', 'ICC Boss', 'Utility', 'Raid Leader'];

        function switchGuideType(type, btn) {
            currentGuideType = type;
            document.querySelectorAll('#guides-tab .filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const labels = { addons: 'Addon', weakauras: 'WeakAura' };
            document.getElementById('guideTypeLabel').textContent = labels[type] || 'Item';
            document.getElementById('addGuideTypeLabel').textContent = labels[type] || 'Item';

            // Update category dropdown
            const categorySelect = document.getElementById('newGuideCategory');
            const categories = type === 'weakauras' ? waCategories : addonCategories;
            categorySelect.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');

            // Show/hide import string field
            const importGroup = document.getElementById('importStringGroup');
            if (importGroup) {
                importGroup.style.display = type === 'weakauras' ? 'block' : 'none';
            }

            loadGuides();
        }

        async function seedGuides() {
            if (!confirm('This will reset addons and weakauras to default data. Continue?')) return;

            try {
                const response = await fetch('/api/seed-guides', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': ADMIN_PASSWORD
                    }
                });

                const result = await response.json();
                if (result.success) {
                    alert(`Synced! ${result.addons} addons and ${result.weakauras} weakauras loaded.`);
                    loadGuides();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Initialize categories on load
        document.addEventListener('DOMContentLoaded', () => {
            const categorySelect = document.getElementById('newGuideCategory');
            if (categorySelect) {
                categorySelect.innerHTML = addonCategories.map(c => `<option value="${c}">${c}</option>`).join('');
            }
        });

        async function loadGuides() {
            const container = document.getElementById('guidesList');
            container.innerHTML = '<div class="empty-state"><span class="loading"></span> Loading...</div>';

            try {
                const response = await fetch(`/api/guides?type=${currentGuideType}`);
                const data = await response.json();
                allGuides = data.items || [];

                displayGuides(allGuides);
            } catch (error) {
                container.innerHTML = `<div class="empty-state"><p style="color: #ef4444;">Error: ${error.message}</p></div>`;
            }
        }

        function displayGuides(items) {
            const container = document.getElementById('guidesList');

            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No items found. Click "Sync Default Data" to load initial data, or add your own!</p></div>';
                return;
            }

            // Group by category
            const groups = {};
            items.forEach(item => {
                const cat = item.category || 'General';
                if (!groups[cat]) groups[cat] = [];
                groups[cat].push(item);
            });

            let html = `<p style="color: var(--text-muted); margin-bottom: 16px;">Total: ${items.length} items</p>`;

            Object.keys(groups).sort().forEach(category => {
                html += `<h4 style="color: var(--horde-red-light); margin: 16px 0 8px 0; font-size: 0.9rem;">${category} (${groups[category].length})</h4>`;
                groups[category].forEach((item, idx) => {
                    const hasContent = item.content && item.content.length > 10;
                    const actualIndex = items.findIndex(i => i.id === item.id);
                    html += `
                        <div class="raid-item">
                            <div class="raid-item-info">
                                <h4>${item.name} ${hasContent ? '<span style="color: #22c55e; font-size: 0.7rem; background: rgba(34,197,94,0.2); padding: 2px 6px; border-radius: 4px;">HAS IMPORT</span>' : ''}</h4>
                                <p>${item.description || ''} ${item.url ? '| Has URL' : ''}</p>
                            </div>
                            <div class="raid-item-actions">
                                ${item.url ? `<a href="${item.url}" target="_blank" class="btn-parse" style="text-decoration: none;">Open</a>` : ''}
                                <button class="btn-edit" onclick="editGuideByIndex(${actualIndex})">Edit</button>
                                <button class="btn-delete" onclick="deleteGuideByIndex(${actualIndex})">Remove</button>
                            </div>
                        </div>
                    `;
                });
            });

            container.innerHTML = html;
        }

        function editGuideByIndex(index) {
            const item = allGuides[index];
            if (item) editGuide(item.id);
        }

        function deleteGuideByIndex(index) {
            const item = allGuides[index];
            if (item) deleteGuide(item.id);
        }

        async function addGuide() {
            const name = document.getElementById('newGuideName').value.trim();
            const category = document.getElementById('newGuideCategory').value;
            const description = document.getElementById('newGuideDesc').value.trim();
            const url = document.getElementById('newGuideUrl').value.trim();
            const content = document.getElementById('newGuideContent').value.trim();
            const priority = parseInt(document.getElementById('newGuidePriority').value) || 0;

            if (!name) {
                showError('addGuideError', 'Please enter a name');
                return;
            }

            try {
                const response = await fetch(`/api/guides?type=${currentGuideType}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': ADMIN_PASSWORD
                    },
                    body: JSON.stringify({ name, category, description, url, content, priority })
                });

                const result = await response.json();
                if (result.success) {
                    showSuccess('addGuideSuccess', 'Added successfully!');
                    document.getElementById('newGuideName').value = '';
                    document.getElementById('newGuideDesc').value = '';
                    document.getElementById('newGuideUrl').value = '';
                    document.getElementById('newGuideContent').value = '';
                    document.getElementById('newGuidePriority').value = '0';
                    loadGuides();
                } else {
                    showError('addGuideError', result.error);
                }
            } catch (error) {
                showError('addGuideError', error.message);
            }
        }

        function editGuide(itemId) {
            const item = allGuides.find(g => g.id === itemId);
            if (!item) return;

            const newName = prompt('Name:', item.name);
            if (newName === null) return;

            const newDesc = prompt('Description:', item.description || '');
            if (newDesc === null) return;

            const newUrl = prompt('URL:', item.url || '');
            if (newUrl === null) return;

            updateGuide(itemId, { name: newName, description: newDesc, url: newUrl });
        }

        async function updateGuide(itemId, updates) {
            try {
                const response = await fetch(`/api/guides?type=${currentGuideType}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Password': ADMIN_PASSWORD
                    },
                    body: JSON.stringify({ id: itemId, ...updates })
                });

                const result = await response.json();
                if (result.success) {
                    loadGuides();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteGuide(itemId) {
            if (!confirm('Remove this item?')) return;

            try {
                const response = await fetch(`/api/guides?type=${currentGuideType}&id=${itemId}`, {
                    method: 'DELETE',
                    headers: { 'X-Admin-Password': ADMIN_PASSWORD }
                });

                const result = await response.json();
                if (result.success) {
                    loadGuides();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ==================== UTILITIES ====================

        function showSuccess(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        // Mobile nav toggle
        document.getElementById('navToggle').addEventListener('click', function() {
            this.classList.toggle('active');
            document.querySelector('.nav-links').classList.toggle('active');
        });

        window.addEventListener('scroll', () => {
            document.getElementById('nav').classList.toggle('scrolled', window.scrollY > 50);
        });

        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeEditModal();
        });

        // Close modal on outside click
        document.getElementById('editRaidModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeEditModal();
        });
    </script>
</body>
</html>
